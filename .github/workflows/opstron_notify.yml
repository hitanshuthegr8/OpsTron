name: OpsTron Deployment Protection

# Triggers on every push to main branch
on:
  push:
    branches: [main, master]
  # Also trigger on pull request merge
  pull_request:
    types: [closed]
    branches: [main, master]

jobs:
  notify-opstron:
    runs-on: ubuntu-latest
    # Only run if it's a push OR a merged PR
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
      - name: Notify OpsTron Agent
        run: |
          echo "ðŸš€ Notifying OpsTron of deployment..."
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          
          # Send deployment notification to OpsTron
          # Replace YOUR_OPSTRON_URL with your actual server URL
          # Options:
          #   - Local: http://localhost:8001
          #   - Ngrok: https://your-tunnel.ngrok.io
          #   - Production: https://your-server.com
          
          curl -X POST "${{ secrets.OPSTRON_URL }}/notify-deployment" \
            -H "Content-Type: application/json" \
            -d '{
              "commit_sha": "${{ github.sha }}",
              "repository": "${{ github.repository }}",
              "author": "${{ github.actor }}",
              "message": "${{ github.event.head_commit.message || github.event.pull_request.title }}",
              "branch": "${{ github.ref_name }}"
            }' \
            --fail --silent --show-error \
            && echo "âœ… OpsTron notified successfully!" \
            || echo "âš ï¸ OpsTron notification failed (server may be offline)"
        env:
          # Set this secret in your GitHub repo settings
          # Settings > Secrets and variables > Actions > New repository secret
          # Name: OPSTRON_URL
          # Value: http://your-server-ip:8001
          OPSTRON_URL: ${{ secrets.OPSTRON_URL }}
