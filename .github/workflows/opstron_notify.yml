name: OpsTron Deployment Notifier

on:
  push:
    branches: [main]

jobs:
  notify-opstron:
    runs-on: ubuntu-latest
    steps:
      - name: Notify OpsTron of Deployment
        run: |
          # Build the JSON payload
          PAYLOAD=$(cat <<EOF
          {
            "commit_sha": "${{ github.sha }}",
            "repository": "${{ github.repository }}",
            "author": "${{ github.actor }}",
            "message": "${{ github.event.head_commit.message }}",
            "branch": "${{ github.ref_name }}"
          }
          EOF
          )

          # Compute HMAC-SHA256 signature using the shared secret
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "${{ secrets.OPSTRON_WEBHOOK_SECRET }}" | awk '{print $2}')

          # POST to OpsTron backend with the signature header
          curl -X POST "${{ secrets.OPSTRON_BACKEND_URL }}/notify-deployment" \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD"
